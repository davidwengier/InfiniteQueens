@using InfiniteQueens.Models
@using InfiniteQueens.Services
@using Microsoft.AspNetCore.Components.Web

<div class="board" 
     style="grid-template-columns: repeat(@BoardSize, 1fr); --board-size: @BoardSize; @(IsHidden ? "display: none;" : "")"
     @onpointermove="HandleBoardPointerMove"
     @onpointermove:preventDefault="true"
     @onpointerup="OnCellPointerUp"
     @onpointercancel="OnCellPointerUp">
    @for (int row = 0; row < BoardSize; row++)
    {
        @for (int col = 0; col < BoardSize; col++)
        {
            var r = row;
            var c = col;
            var region = GameState.Regions[row, col];
            var cellState = GameState.Board[row, col];
            var isAutoMark = GameState.AutoMarks[row, col];
            var hasConflict = GameState.HasConflict(row, col);
            
            <div class="cell region-@region @(hasConflict ? "conflict" : "")"
                 data-row="@r"
                 data-col="@c"
                 @onclick="() => OnCellClick.InvokeAsync((r, c))"
                 @onpointerdown="(e) => OnCellPointerDown.InvokeAsync((e, r, c))"
                 @onpointerdown:preventDefault="true"
                 @onpointerenter="() => OnCellPointerEnter.InvokeAsync((r, c))"
                 @onpointerup="OnCellPointerUp"
                 @onpointercancel="OnCellPointerUp"
                 @oncontextmenu:preventDefault="true">
                @if (cellState == CellState.ManualCross || isAutoMark)
                {
                    <span class="cross @(isAutoMark ? "auto" : "")">✕</span>
                }
                else if (cellState == CellState.Queen)
                {
                    <span class="queen">♛</span>
                }
            </div>
        }
    }
</div>

@code {
    [Parameter]
    public int BoardSize { get; set; }
    
    [Parameter]
    public bool IsHidden { get; set; }
    
    [Parameter]
    public GameState GameState { get; set; } = null!;
    
    [Parameter]
    public EventCallback<(int row, int col)> OnCellClick { get; set; }
    
    [Parameter]
    public EventCallback<(PointerEventArgs e, int row, int col)> OnCellPointerDown { get; set; }
    
    [Parameter]
    public EventCallback<(int row, int col)> OnCellPointerEnter { get; set; }
    
    [Parameter]
    public EventCallback<PointerEventArgs> OnBoardPointerMove { get; set; }
    
    [Parameter]
    public EventCallback OnCellPointerUp { get; set; }
    
    private async Task HandleBoardPointerMove(PointerEventArgs e)
    {
        await OnBoardPointerMove.InvokeAsync(e);
    }
}
